{"version":3,"sources":["LoginService.js"],"names":["Object","defineProperty","exports","value","GameEngine_1","require","GameSceneHepler_1","ServerUrls_1","StringUtils_1","LoginService","prototype","checkLogin","_this","wx","getSetting","success","res","playerId","GameEngine","localStorage","get","playerIdKey","cc","log","StringUtils","isEmpty","checkSession","getUserInfo","fail","login","withCredentials","lang","encryptedData","iv","params","http","httpPost","ServerUrls","GET_USER_URL","response","showTips","message","changeScene","GameSceneHepler","GAME","code","LOGIN_URL","register","REGISTER_URL"],"mappings":"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","file":"LoginService.js","sourceRoot":"..\\..\\..\\..\\..\\..\\..\\..\\assets\\Script\\src\\game\\common\\service","sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar GameEngine_1 = require(\"../GameEngine\");\r\nvar GameSceneHepler_1 = require(\"../helper/GameSceneHepler\");\r\nvar ServerUrls_1 = require(\"../../../utils/ServerUrls\");\r\nvar StringUtils_1 = require(\"../../../utils/StringUtils\");\r\nvar LoginService = (function () {\r\n    function LoginService() {\r\n    }\r\n    LoginService.prototype.checkLogin = function () {\r\n        var _this = this;\r\n        wx.getSetting({\r\n            success: function (res) {\r\n                var playerId = GameEngine_1.GameEngine.localStorage.get(GameEngine_1.GameEngine.playerIdKey);\r\n                cc.log(\"wx.getSetting playerId: \" + playerId + \" , res: \", res);\r\n                cc.log(\"!res.authSetting['scope.userInfo']: \" + !res['scope.userInfo'] + \" \");\r\n                cc.log(\"StringUtils.isEmpty(playerId): \" + StringUtils_1.StringUtils.isEmpty(playerId) + \" \");\r\n                cc.log(\"!res.authSetting['scope.userInfo'] || StringUtils.isEmpty(playerId)  : \" + (!res['scope.userInfo'] ||\r\n                    StringUtils_1.StringUtils.isEmpty(playerId)));\r\n                wx.checkSession({\r\n                    success: function (res) {\r\n                        cc.log(\"wx.checkSession success , res: \", res);\r\n                        _this.getUserInfo();\r\n                    },\r\n                    fail: function (res) {\r\n                        cc.log(\"wx.checkSession fail , res: \", res);\r\n                        _this.login();\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n    LoginService.prototype.getUserInfo = function () {\r\n        wx.getUserInfo({\r\n            withCredentials: false,\r\n            lang: \"zh_CN\",\r\n            success: function (res) {\r\n                cc.log(\"res--getUserInfo = \" + res);\r\n                var encryptedData = res.encryptedData;\r\n                var iv = res.iv;\r\n                var params = {\r\n                    \"playerId\": GameEngine_1.GameEngine.localStorage.get(GameEngine_1.GameEngine.playerIdKey),\r\n                    \"encryptedData\": encryptedData,\r\n                    \"iv\": iv\r\n                };\r\n                cc.log(\"wx.getUserInfo res: : \", res);\r\n                GameEngine_1.GameEngine.http.httpPost(ServerUrls_1.ServerUrls.GET_USER_URL, params, function (response) {\r\n                    if (!response.success) {\r\n                        GameEngine_1.GameEngine.showTips(response.message);\r\n                        return;\r\n                    }\r\n                    GameEngine_1.GameEngine.changeScene(GameSceneHepler_1.GameSceneHepler.GAME);\r\n                });\r\n            },\r\n        });\r\n    };\r\n    LoginService.prototype.login = function () {\r\n        wx.login({\r\n            success: function (res) {\r\n                cc.log(\"wx.login res: : \", res);\r\n                var code = res.code;\r\n                var params = {\r\n                    \"code\": code,\r\n                };\r\n                GameEngine_1.GameEngine.http.httpPost(ServerUrls_1.ServerUrls.LOGIN_URL, params, function (response) {\r\n                    if (!response.success) {\r\n                        GameEngine_1.GameEngine.showTips(response.message);\r\n                        return;\r\n                    }\r\n                    GameEngine_1.GameEngine.changeScene(GameSceneHepler_1.GameSceneHepler.GAME);\r\n                });\r\n            },\r\n        });\r\n    };\r\n    LoginService.prototype.register = function (encryptedData, iv) {\r\n        wx.login({\r\n            success: function (res) {\r\n                cc.log(\"wx.login res: : \", res);\r\n                var code = res.code;\r\n                var params = {\r\n                    \"code\": code,\r\n                    \"encryptedData\": encryptedData,\r\n                    \"iv\": iv\r\n                };\r\n                GameEngine_1.GameEngine.http.httpPost(ServerUrls_1.ServerUrls.REGISTER_URL, params, function (response) {\r\n                    if (!response.success) {\r\n                        GameEngine_1.GameEngine.showTips(response.message);\r\n                        return;\r\n                    }\r\n                    cc.log(\"register response\", response);\r\n                    GameEngine_1.GameEngine.changeScene(GameSceneHepler_1.GameSceneHepler.GAME);\r\n                });\r\n            },\r\n        });\r\n    };\r\n    return LoginService;\r\n}());\r\nexports.LoginService = LoginService;\r\n"]}